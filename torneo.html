<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dettagli Torneo - Club Go FVG</title>
    <link rel="stylesheet" href="assets/css/style.css" />
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  </head>
  <body>
    <header class="site-header">
      <div class="container header-inner">
        <div class="brand">
          <img src="assets/img/logoHiga.jpg" class="logo" alt="" />
          <span id="page-subtitle">Dettagli Torneo</span>
        </div>
        <nav class="nav">
          <a href="./tornei.html" class="btn btn-ghost small">← Tornei</a>
        </nav>
      </div>
    </header>

    <main class="container content">
      <section class="panel">
        <div class="split">
          <div id="md-render" style="max-width: 800px; line-height: 1.6;">
            Caricamento dettagli torneo...
          </div>

          <div class="note muted small" style="min-width: 250px;">
            <p><strong>Nota privacy:</strong> i dati raccolti servono unicamente per la gestione del torneo.</p>
            <div id="registration-container" style="margin-top: 20px;">
               </div>
          </div>
        </div>
      </section>

      <section class="panel">
        <h2>Pre-iscritti</h2>
        <div class="iscritti-grid" id="iscritti">
            <p>Caricamento lista...</p>
        </div>
      </section>
    </main>

    <footer class="site-footer">
      <div class="container footer-inner">
        <p>© 2026 Club Go FVG</p>
      </div>
    </footer>

    <script src="assets/js/sheet-loader.js"></script>

    <script>
      const params = new URLSearchParams(window.location.search);
      let fileName = params.get('f');

      if (fileName) {
        const cleanName = fileName.replace('.md', '').trim();
        const filePath = `tornei/${cleanName}.md`;

        console.log("Tentativo di caricamento:", filePath);
        fetch(`${filePath}`)
          .then(res => {
            if (!res.ok) throw new Error("File MD non trovato");
            return res.text();
          })
          .then(text => {
            // Dividiamo i metadati (Front Matter) dal testo
            const parts = text.split('---');
            let mdBody = text;

            if (parts.length >= 3) {
              const header = parts[1];
              mdBody = parts.slice(2).join('---');

              // Estraiamo i link con una Regex più flessibile
              const titleMatch = header.match(/titolo_breve:\s*"(.*?)"/);
              const csvMatch = header.match(/csv_link:\s*"(.*?)"/);
              const formMatch = header.match(/form_link:\s*"(.*?)"/);

              // 1. Applichiamo il Titolo
              if (titleMatch) {
                document.getElementById('page-subtitle').textContent = titleMatch[1];
                document.title = titleMatch[1];
              }

              // 2. Carichiamo la lista iscritti (CSV)
              if (csvMatch && csvMatch[1]) {
                console.log("Carico CSV da:", csvMatch[1]);
                if (typeof loadIscritti === 'function') {
                    loadIscritti(csvMatch[1], "#iscritti");
                }
              }

              // 3. Creiamo il bottone Form
              if (formMatch && formMatch[1]) {
                document.getElementById('registration-container').innerHTML = 
                  `<a class="btn btn-primary" href="${formMatch[1]}" target="_blank">Iscriviti / Register</a>`;
              }
            }

            // Infine renderizziamo il Markdown nel div dedicato
            document.getElementById('md-render').innerHTML = marked.parse(mdBody);
          })
          .catch(err => {
            console.error(err);
            document.getElementById('md-render').innerHTML = "Impossibile caricare i dettagli del torneo.";
          });
      }
    </script>
  </body>
</html>
